{% extends 'shopping/optimum/base.html' %}
{% load i18n humanize static auth_tokens %}

{% block page_title %}
<title> {% if obj.member.is_ghost %}{{ obj.member.email }}{% else %}{{ obj.member.full_name }}{% endif %} - {{ service.project_name }} </title>
{% endblock %}

{% block head_style %}
    {{ block.super }}
    <link rel='stylesheet' href="{% static 'ikwen/css/base.css' %}" />
    <link rel='stylesheet' href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <style>
        section {margin:50px 0;}
        section h3 {margin: 15px 0; font-weight: 500}
        section > div {margin-top: 15px}
        section:last-of-type .ik-li {border-top: solid #efefee 1px}
        .welcome-title h2 {font-weight: 800}
        .welcome-title {width:150px; height: 150px; border: none; background-size: cover; background-position: center}
        .object-list .ik-li {padding: 15px; margin-top: 15px; border: none; background-color: transparent}
        .object-list .ik-li:hover {background-color: #efefee}
        @media only screen and (max-width: 767px) {
            .ik-li {
                padding-left: 0!important;
                padding-right: 0!important;
            }

        }
    </style>
{% endblock %}

{% block breadcrumb_location %}
    <li>
        <a href="{% url 'ikwen:community' %}">{% trans 'Community' %}</a>
    </li>
    <li>
        {% trans "Customer Journey" %}
    </li>
{% endblock %}

{% block content %}
    <div id="content">
        <div class="container">
            <div id="stage" style="float: none; margin: auto">
                <div>
                    <div class="text-center">
                        <span class="welcome-title img-circle img-thumbnail" style=" background-image: url({% static 'kakocase/img/order-history2.png' %})">
{#                            <i class="fa fa-shopping-cart" style="font-size: 70px; font-weight: 600; color: red"></i>#}
                        </span>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <h2 class="text-center">{% trans 'Orders history' %}</h2>
                <div class="col-sm-8 col-sm-offset-2" >
                    <section>
                        <h3>{% trans 'Orders' %}</h3>
                        <div>
                            <label>{% trans 'Count' %}</label>
                            <span class="pull-right {% if not customer.total_orders_count %}text-muted{% endif %}">
                                {% if customer.total_orders_count %}
                                    {{ customer.total_orders_count|intcomma }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </div>
                        <div>
                            <label>{% trans 'Amount' %}</label>
                            <span class="pull-right {% if not customer.total_orders_count %}text-muted{% endif %}">
                                {% if customer.total_orders_count %}
                                    {{ customer.total_turnover|intcomma }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </div>
                        <div>
                            <label>{% trans 'Last' %}</label>
                            <span class="pull-right {% if not customer.total_orders_count %}text-muted{% endif %}">
                                {% if customer.total_orders_count %}
                                    {{ customer.last_payment_on }}
                                {% else %}
                                    &#60;Never&#62;
                                {% endif %}
                            </span>
                        </div>
                    </section>
                    {% if order_history_list|length > 0 %}
                        <section>
                            <h3>{% trans 'Delivery Addresses' %}</h3>
                            <ul class="object-list list-group delivery-addresses">
                                {% for address in customer.delivery_addresses %}
                                <li class="ik-li list-group-item" id="address-{{ forloop.counter }}" data-address="address-{{ forloop.counter }}" data-item="{{ forloop.counter0 }}">
                                    <div class="col-sm-10 address-details">
                                        <input type="hidden" id="set-country" value="{{ address.country }}">
                                        <input type="hidden" id="current-city" value="{{ address.city }}">
                                        <input type="hidden" id="current-address" value="{{ address.details }}">
                                        <input type="hidden" id="current-postal-code" value="{{ address.postal_code }}">
                                        <input type="hidden" id="current-email" value="{{ address.email }}">
                                        <input type="hidden" id="current-phone" value="{{ address.phone }}">
                                        <div>
                                            {{ address.details }} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            {% if address.postal_code %}
                                                {% trans 'P.O BOX:' %} &nbsp;{{ address.postal_code }}
                                            {% endif %}
                                        </div>
                                        {% if address.city and address.country %}
                                            <div style="font-weight: bold;">
                                                {{ address.city }}, {{ address.country }}
                                            </div>
                                        {% endif %}
                                        <div class="text-muted">
                                            {{ address.email }}, {{ address.phone }}
                                        </div>
                                    </div>
                                    <div class="actions col-sm-2">
                                        <i class="fa fa-edit edit"></i>
                                        <i class="glyphicon glyphicon-trash delete" data-action="delete"></i>
                                        <div class="clearfix"></div>
                                    </div>
                                    <form method="post" class="form-group tpl set-address">
                                        {% csrf_token %}
                                        <input type="hidden" id="previous-address-index" name="previous_address_index" />
                                        <input type="hidden" name="delivery_option_id" value="{{ request.GET.delivery_option_id }}" />
                                        <input type="hidden" name="item" value="{{ forloop.counter0 }}" />
                                        <div>
                                            {% if not pick_up_in_store %}
                                                <div class="form-group row">
                                                    <label for="country" class="col-sm-4 col-md-3">{% trans "Country" %}</label>
                                                    <div class="col-sm-7 col-md-7">
                                                        <select id="country" class="form-control required" name="country_iso2">
                                                            {% for country in countries %}
                                                            <option class="entry" value="{{ country.iso2 }}">{% trans country.name %}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="city" class="col-sm-4 col-md-3">{% trans "City" %}</label>
                                                    <div class="col-sm-7 col-md-7">
                                                        <input id="city" class="form-control required" type="text" name="city" {% if address.city %}value="{{ address.city }}" {% endif %}/>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label for="details" class="col-sm-4 col-md-3">{% trans "Address" %}</label>
                                                    <div class="col-sm-7 col-md-7">
                                                        <input id="details" class="form-control required" type="text" name="details" {% if address.details %}value="{{ address.details }}" {% endif %} />
                                                    </div>
                                                </div>
                                                {% if config.is_pro_version %}
                                                    <div class="form-group row">
                                                        <label for="postal-code"
                                                               class="col-sm-4 col-md-3">{% trans "Postal Code" %}</label>
                                                        <div class="col-sm-7 col-md-7">
                                                            <input id="postal-code" class="form-control required" type="text"
                                                                   name="postal_code" {% if address.postal_code %}{{ address.postal_code }}{% endif %}/>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                            <div class="form-group row">
                                                <label for="phone" class="col-sm-4 col-md-3">{% trans "Phone" %}</label>
                                                <div class="col-sm-7 col-md-7">
                                                    <input id="phone" class="form-control required" type="text" name="phone" value="{{ user.phone }}" />
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="email" class="col-sm-4 col-md-3">Email</label>
                                                <div class="col-sm-7 col-md-7">
                                                    <input id="email" class="form-control required" type="text" name="email" value="{{ user.email }}"/>
                                                </div>
                                            </div>
                                            {% if user.is_anonymous %}
                                                <div class="form-group row">
                                                    <label for="name" class="col-sm-4 col-md-3">{% trans "Your name" %}</label>
                                                    <div class="col-sm-7 col-md-7">
                                                        <input id="name" class="form-control required" type="text" name="name"/>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <input id="name" type="hidden" name="name" value="{{ user.full_name }}"/>
                                            {% endif %}
                                            <div class="form-group row">
                                                <div class="col-sm-5 col-md-4 col-sm-offset-5 col-md-offset-6">
                                                    <button type="submit" class="btn btn-warning cta" style="width: 200px">
                                                            {% trans "Save" %}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </li>
                                {% endfor %}
                            </ul>
                            <div class="clearfix"></div>
                        </section>
                        <section>
                            <h3>{% trans "History" %}</h3>
                            <ul class="object-list list-group">
                                {% for order in order_history_list %}
                                {% url 'shopping:cart' order.id as obj_url %}
                                <li class="ik-li list-group-item" id="{{ order.id }}" data-id="{{ order.id }}">
                                    <a href="{{ obj_url }}" target="_blank">{{ order|upper }}</a>
                                    <div class="pull-right text-muted">
                                        {{ order.created_on|date }}
                                    </div>
                                    <div>
                                        <span class="pull-left">
                                            <strong>{{ order.get_products_as_string }}</strong>
                                        </span>
                                        <span class="pull-right">
                                            <span class="text-muted" style="font-size: .8em">{{ order.currency }}</span>
                                            <strong>{{ order.total_cost|intcomma }}</strong>
                                        </span>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            <div class="clearfix"></div>
                        </section>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    {{ block.super }}
    <script>
        (() => {
            $('body').on('click', '.edit', (e) => {
                let $parent = $(e.target).parents('.ik-li'),
                    _address = $parent.data('address'),
                    _ik_li = `.delivery-addresses .ik-li#${_address}`;
                $(`.delivery-addresses .ik-li:not(#${_address}),  ${_ik_li} .address-details,  ${_ik_li} .actions`).hide();
                $parent.find('form.set-address').show();

            }).on('click', '.delete', (e) => {
                let params = {
                    'item': $(e.target).parents('.ik-li').data('item'),
                    'action': $(e.target).data('action')
                };
                $.getJSON('', params, (data) => {
                    if(data.success) {
                        $(`.ik-li#address-${params.item}`).remove();
                        ikwen.showFloatingNotice("Address removed", 2000);
                    }
                })
            });
        })()
    </script>
{% endblock %}
